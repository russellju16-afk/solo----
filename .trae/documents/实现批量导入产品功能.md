# 批量导入产品功能实现计划

## 一、后端实现

### 1. 安装依赖
- 安装 `exceljs` 库用于生成和解析Excel文件

### 2. 实现模板生成功能
- 在 `ProductService` 中实现 `generateImportTemplate()` 方法
- 生成包含两个Sheet的Excel文件：
  - Sheet1: `products` - 产品数据导入表，包含所有必填和可选字段
  - Sheet2: `说明` - 包含字段说明、枚举值说明等
- 模板字段映射：
  | 中文表头 | 字段名 | 类型 | 必填 | 说明 |
  |---------|--------|------|------|------|
  | 产品名称 | name | 字符串 | 是 | 产品的名称 |
  | 品类ID | category_id | 数字 | 否 | 品类ID，与品类名称二选一 |
  | 品类名称 | category_name | 字符串 | 否 | 品类名称，与品类ID二选一 |
  | 品牌ID | brand_id | 数字 | 否 | 品牌ID，与品牌名称二选一 |
  | 品牌名称 | brand_name | 字符串 | 否 | 品牌名称，与品牌ID二选一 |
  | 规格重量 | spec_weight | 字符串 | 是 | 如：5kg/10kg/25kg |
  | 包装类型 | package_type | 字符串 | 是 | 如：袋装/箱装 |
  | 适用场景 | applicable_scenes | 字符串 | 否 | 多选，用英文逗号分隔，如：高校,团餐 |
  | 最低起订量 | moq | 字符串 | 否 | 如：100箱 |
  | 供应区域 | supply_area | 字符串 | 否 | 如：全国 |
  | 产品描述 | description | 字符串 | 否 | 产品的详细描述 |
  | 状态 | status | 字符串/数字 | 否 | 1/上架=上架，0/下架=下架，默认上架 |
  | 价格趋势 | price_trend | 字符串 | 否 | up/上涨, down/下降, flat/持平 |
  | 最近价格更新时间 | latest_price_updated_at | 日期 | 否 | 如：2024-01-01 |
  | 最近价格备注 | latest_price_note | 字符串 | 否 | 内部参考备注 |

### 3. 实现Excel导入功能
- 在 `ProductService` 中实现 `importProductsFromExcel()` 方法
- 实现Excel解析、数据清洗、校验、去重和导入逻辑
- 具体步骤：
  1. 解析Excel文件，读取Sheet1数据
  2. 数据清洗：trim、空字符串转null、状态值转换等
  3. 数据校验：
     - 必填字段校验
     - 数据类型校验
     - 品牌/品类存在性校验（支持ID或名称匹配）
  4. 去重策略：
     - 文件内去重：按 `name+spec_weight+category+brand` 唯一键去重
     - 数据库去重：与现有产品比对，避免重复导入
  5. 批量导入：
     - 采用事务处理
     - 逐行收集错误，成功的批量插入（分批100条）
     - 生成错误明细Excel文件
  6. 返回导入结果：成功条数、失败条数、错误列表、错误文件URL

## 二、前端实现

### 1. 添加批量导入按钮
- 在产品管理页面的顶部操作区域添加【批量导入】按钮
- 按钮位置：新增产品/刷新按钮旁边
- 权限与新增产品一致

### 2. 实现批量导入模态框
- 模态框包含以下功能：
  - 下载模板：调用 `GET /admin/products/import-template` 接口下载模板
  - 上传Excel：使用Antd Upload组件，支持 .xlsx/.xls 文件，大小限制10MB
  - 显示导入结果：
    - 成功条数/失败条数统计
    - 失败原因列表（前20条）
    - 错误明细Excel下载按钮
  - 确认导入：将预检通过的数据写入数据库
  - 取消：关闭模态框

### 3. 实现导入流程
- 点击批量导入按钮 -> 打开模态框
- 下载模板 -> 填写数据 -> 上传文件
- 显示导入预检结果 -> 确认导入
- 显示导入进度 -> 导入完成后刷新产品列表
- 显示导入结果提示

## 三、验收用例

1. **下载模板**：点击下载模板按钮，能成功下载Excel模板，包含正确的表头和示例数据
2. **正确导入**：使用模板填写3条合法数据，导入成功，产品列表中新增3条记录
3. **校验失败**：模板中故意缺少必填字段，导入失败，显示明确的错误信息
4. **品牌/品类匹配**：填品牌/品类名称能正确匹配，填不存在的名称会报错
5. **去重功能**：重复导入同一文件，不会产生重复记录，显示明确的去重提示

## 四、文件修改清单

### 后端
- `server/package.json` - 添加exceljs依赖
- `server/src/modules/product/product.service.ts` - 实现模板生成和Excel导入方法

### 前端
- `admin/src/pages/Products/index.tsx` - 添加批量导入按钮
- `admin/src/pages/Products/components/ProductImportModal.tsx` - 新增批量导入模态框组件
- `admin/src/services/product.ts` - 添加批量导入相关API调用

## 五、实现顺序

1. 后端实现模板生成功能
2. 后端实现Excel导入功能
3. 前端实现批量导入模态框组件
4. 前端在产品管理页面添加批量导入按钮
5. 测试所有功能，确保符合验收用例要求

## 六、技术要点

- 后端使用exceljs库处理Excel文件
- 采用事务确保数据一致性
- 实现幂等/去重策略，避免重复导入
- 提供清晰的错误信息和错误明细下载
- 前端使用Antd Upload组件处理文件上传
- 实现良好的用户交互体验，包括加载状态、进度提示和结果反馈
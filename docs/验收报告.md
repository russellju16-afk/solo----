# 本地端到端验收报告（可上线验收）

验收时间：2025-12-14  
仓库路径：`/Users/russell/solo超群官网`

## 0) 自动识别项目与启动方式

### 0.1 包管理器识别

依据 lock 文件：
- 根目录：`package-lock.json`
- `admin/`：`admin/package-lock.json`
- `server/`：`server/package-lock.json`

结论：本仓库使用 `npm`。

### 0.2 三端项目识别

- `server/`：NestJS API（全局前缀 `/api`）
- `admin/`：后台（Vite + React）
- 根目录：前台（Vite + React）

### 0.3 启动命令清单（按实际 scripts，不猜）

从 `package.json` 读取的启动脚本对应命令：

- `server`（start:dev）：`npm --prefix server run start:dev`
- `admin`（dev）：`npm --prefix admin run dev`
- `web`（dev）：`npm run dev`

> 本次验收实际启动方式为 3 个终端分别执行等价命令（见 2.2）。

## 1) 本地依赖安装（必须完成）

### 1.1 环境信息

```bash
$ node -v && npm -v
v25.2.1
11.6.2
```

### 1.2 根目录依赖安装

```bash
$ /usr/bin/time -p npm install

up to date, audited 351 packages in 1s

64 packages are looking for funding
  run `npm fund` for details

2 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
real 1.56
user 0.62
sys 0.16
```

### 1.3 server 依赖安装

```bash
$ cd server
$ /usr/bin/time -p npm install

removed 11 packages, and audited 588 packages in 3s

97 packages are looking for funding
  run `npm fund` for details

6 vulnerabilities (4 low, 2 high)

To address all issues, run:
  npm audit fix

Run `npm audit` for details.
real 3.52
user 0.89
sys 0.19
```

### 1.4 admin 依赖安装

```bash
$ cd admin
$ /usr/bin/time -p npm install

added 1 package, and audited 297 packages in 739ms

49 packages are looking for funding
  run `npm fund` for details

2 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
real 0.81
user 0.52
sys 0.11
```

> 说明：本次验收未在验收过程中执行 `npm audit fix`（可能引入破坏性升级），已将漏洞作为“仍存在问题”列入收口清单。

## 2) 本地启动与健康检查（必须完成）

### 2.1 启动端口与监听情况

本次验收最终监听端口（以真实监听为准）：

```bash
$ lsof -nP -iTCP:3002 -sTCP:LISTEN
node  41354  russell  ...  TCP *:3002 (LISTEN)

$ lsof -nP -iTCP:3000 -sTCP:LISTEN
node  36267  russell  ...  TCP *:3000 (LISTEN)

$ lsof -nP -iTCP:5173 -sTCP:LISTEN
node  43754  russell  ...  TCP [::1]:5173 (LISTEN)
```

端口分配结论：
- `server`：`3002`
- `web`：`3000`
- `admin`：`5173`

### 2.2 三端启动日志（关键输出）

#### server（NestJS）

关键日志（从运行日志中提取）：
- 已映射上传路由：`Mapped {/api/admin/upload/image, POST} route`
- 已成功监听：`Application is running on: http://localhost:3002`

> 本次过程中遇到过一次 `EADDRINUSE :::3002`（端口占用）并已清理旧进程后重启成功。

#### web（前台 Vite）

```text
VITE v5.4.21  ready in 137 ms
➜  Local:   http://localhost:3000/
```

> 本次过程中遇到过一次 `Port 3000 is in use, trying another one...`（端口占用），清理旧进程后固定到 3000。

#### admin（后台 Vite）

```text
VITE v5.4.21  ready in 144 ms
➜  Local:   http://localhost:5173/
```

> 启动警告已收口：通过新增 `admin/postcss.config.js` 避免误加载 Tailwind（见“已修复问题”）。

### 2.3 健康检查（HTTP 实测）

```bash
$ curl -s -o /dev/null -w '%{http_code}\n' http://localhost:3002/api/banners
200

$ curl -s -o /dev/null -w '%{http_code}\n' http://localhost:3000/
200

$ curl -s -o /dev/null -w '%{http_code}\n' http://localhost:5173/
200
```

## 3) P0 验收：上传链路必须在本地真实可用（必须通过）

### 3.1 server 上传与静态资源

#### 3.1.1 uploads 目录

```bash
$ ls -la server/uploads | head -n 20
total 120
drwxr-xr-x@  6 russell  staff    192 Dec 14 10:40 .
drwxr-xr-x@ 15 russell  staff    480 Dec 14 10:54 ..
-rw-r--r--@  1 russell  staff  13182 Dec 14 10:36 226aab6d-db73-4207-975b-e9442afaa838.webp
-rw-r--r--@  1 russell  staff  12120 Dec 14 10:40 22c348bd-fe8c-4871-94eb-6e9cf4ea9cd2.webp
-rw-r--r--@  1 russell  staff  12536 Dec 14 10:32 5f32b61b-7839-4792-bfd8-d4ea21d0240d.webp
-rw-r--r--@  1 russell  staff  12536 Dec 14 10:36 9194b0e2-d12f-4e77-853c-36c3a3aa1f76.webp
```

结论：存在 `server/uploads/`，且已产生真实上传文件。

#### 3.1.2 静态托管验证（可直接访问）

```bash
$ curl -I http://localhost:3002/uploads/22c348bd-fe8c-4871-94eb-6e9cf4ea9cd2.webp | head
HTTP/1.1 200 OK
Content-Type: image/webp
Content-Length: 12120
```

结论：`/uploads/**` 静态托管正常。

#### 3.1.3 登录获取 token（上传接口鉴权）

```bash
$ curl -s -X POST http://localhost:3002/api/auth/login \
  -H 'Content-Type: application/json' \
  -d '{"username":"admin","password":"123456"}'

{"token":"eyJhbGciOiJIUzI1...","userInfo":{"id":1,"username":"admin","name":"管理员","phone":"","role":"admin"}}
```

#### 3.1.4 上传接口验证

```bash
$ curl -s -X POST http://localhost:3002/api/admin/upload/image \
  -H "Authorization: Bearer <token>" \
  -F "file=@public/assets/placeholder-card.webp;type=image/webp"

{"url":"/uploads/22c348bd-fe8c-4871-94eb-6e9cf4ea9cd2.webp"}
```

结论：`POST /api/admin/upload/image` 返回 `{ url }`，且 url 可访问。

### 3.2 后台逐模块实测（至少各 1 条数据）

> 说明：以下为“真实接口串联”的网络证据（上传 → 保存 → 刷新），均使用 `/uploads/...` 形式存储，不包含 base64、不包含外链占位域名。

#### 3.2.1 Banner 管理

- 上传返回（示例）：`{"url":"/uploads/226aab6d-db73-4207-975b-e9442afaa838.webp"}`
- 保存（Admin）`POST /api/admin/banners` payload（关键字段）：
  - `image_url: "/uploads/226aab6d-db73-4207-975b-e9442afaa838.webp"`
  - `enabled: 1`
- 刷新校验（Public）：

```bash
$ curl -s http://localhost:3002/api/banners
[{"id":1,"position":"home_top","title":"验收Banner-1765679768","image_url":"/uploads/226aab6d-db73-4207-975b-e9442afaa838.webp",...}]
```

#### 3.2.2 新闻资讯

保存后（Public）列表与详情均可读到 `cover_image`：

```bash
$ curl -s "http://localhost:3002/api/news?page=1&pageSize=5"
{"data":[{"id":1,"title":"验收新闻-1765679768","cover_image":"/uploads/9194b0e2-d12f-4e77-853c-36c3a3aa1f76.webp","status":"published",...}],...}

$ curl -s http://localhost:3002/api/news/1
{"id":1,"title":"验收新闻-1765679768","cover_image":"/uploads/9194b0e2-d12f-4e77-853c-36c3a3aa1f76.webp","status":"published",...}
```

#### 3.2.3 客户案例

```bash
$ curl -s "http://localhost:3002/api/cases?page=1&pageSize=5"
{"data":[{"id":1,"customer_name":"验收客户-1765679768","cover_image":"/uploads/226aab6d-db73-4207-975b-e9442afaa838.webp","status":"published",...}],...}

$ curl -s http://localhost:3002/api/cases/1
{"id":1,"customer_name":"验收客户-1765679768","cover_image":"/uploads/226aab6d-db73-4207-975b-e9442afaa838.webp","status":"published",...}
```

#### 3.2.4 解决方案（封面支持已补齐）

本次验收补齐了 `solutions.cover_image` 字段，并完成上传→保存→刷新验证：

```bash
$ curl -s "http://localhost:3002/api/solutions?page=1&pageSize=5"
{"data":[{"id":1,"cover_image":"/uploads/22c348bd-fe8c-4871-94eb-6e9cf4ea9cd2.webp","title":"验收解决方案-1765679768",...}],...}
```

前台展示策略：有 `cover_image` 则展示封面图；无则继续使用 icon 卡面兜底（避免空白块）。

#### 3.2.5 产品（主图/轮播）

产品使用 `images: string[]`（URL 数组）保存，详情接口可取回：

```bash
$ curl -s http://localhost:3002/api/products/1 | node -p "const j=JSON.parse(require('fs').readFileSync(0,'utf8')); JSON.stringify({id:j.id,name:j.name,images:(j.images||[]).map(i=>i.url)},null,2)"
{
  "id": 1,
  "name": "验收产品-1765679768",
  "images": [
    "/uploads/9194b0e2-d12f-4e77-853c-36c3a3aa1f76.webp",
    "/uploads/226aab6d-db73-4207-975b-e9442afaa838.webp"
  ]
}
```

### 3.3 全仓库清理外链占位与假上传

```bash
$ rg -n "via\\.placeholder\\.com|run\\.mocky" -S .
# 无匹配结果
```

结论：仓库中未发现 `via.placeholder.com` / `run.mocky` 外链占位或假上传残留。

## 4) P0 验收：前台页面必须接口驱动（必须通过）

> 说明：以下为页面对应的 `/api` 接口对照（并已对关键接口进行真实 `curl` 校验，见 3/4.2 输出）。完整接口说明见 `docs/接口对照表.md`。

### 4.1 页面 → 接口对照（前台）

- `/` 首页
  - `GET /api/banners`
  - `GET /api/products?page=1&pageSize=4`
  - `GET /api/news?page=1&pageSize=3`
  - `GET /api/cases?page=1&pageSize=3`
  - `GET /api/company-info`
- `/products` 产品中心
  - `GET /api/categories`
  - `GET /api/products`（分页/keyword/categoryId）
- `/products/:id` 产品详情
  - `GET /api/products/:id`
  - `GET /api/products/:id/recommendations`
  - `GET /api/faqs`（用于“常见问题”区块）
  - `POST /api/leads`（页面内“获取报价”表单）
- `/solutions`
  - `GET /api/solutions`
- `/cases`
  - `GET /api/cases`、`GET /api/cases/:id`
- `/news`
  - `GET /api/news`、`GET /api/news/:id`
- `/about`
  - `GET /api/company-info`
- `/contact`
  - `GET /api/company-info`
  - `GET /api/faqs`
  - `POST /api/leads`

### 4.2 关键接口实测（证据）

#### 4.2.1 FAQ 接口（补齐后不再 404）

```bash
$ curl -s "http://localhost:3002/api/faqs?pageSize=4"
[{"id":1,"question":"支持哪些配送区域？",...}]
```

#### 4.2.2 推荐接口（补齐后不再 404）

```bash
$ curl -s "http://localhost:3002/api/products/1/recommendations?limit=4&categoryId=2"
[]
```

#### 4.2.3 联系页表单可提交并写入后台（线索链路）

```bash
$ curl -s -X POST http://localhost:3002/api/leads \
  -H 'Content-Type: application/json' \
  -d '{"name":"验收线索","companyName":"验收公司","phone":"13800000000","city":"西安","channelType":"university","interestedCategories":["rice","oil"],"monthlyVolumeSegment":"between_5_20t","brandRequirement":"无","description":"验收提交","source":"contact_page"}'
{"success":true,"id":3}
```

并在后台列表可查到（Admin）：

```bash
$ curl -s -H "Authorization: Bearer <token>" "http://localhost:3002/api/admin/leads?page=1&pageSize=1"
{"items":[{"id":3,"companyName":"验收公司","interestedCategories":["rice","oil"],...}],"total":3,...}
```

## 5) UI/体验收口（本地修到“像能上线”的程度）

本次收口已落地（见“已修复问题清单”中的文件）：

- 前台：About/Contact 页面统一使用 `ImageWithFallback`，避免图片缺失导致“空白大块”。
- 前台：Solutions 支持封面图（有图展示，无图 icon 兜底）。
- 后台：Dashboard 指标卡整卡可点，跳转到 `/leads?range=today|month`。
- 后台：Leads 列表支持 `range` URL 参数预填日期，空表格显示友好提示文案。
- 后台：移除误加载 Tailwind 的构建/启动 warning（新增 `admin/postcss.config.js`）。

## 6) 构建与质量门槛（至少做到能打包）

### 6.1 web build

```bash
$ /usr/bin/time -p npm run build
...（省略）...
✓ built in 3.53s
real 5.80
```

说明：出现 Vite chunk size > 500k 警告（不影响构建成功），建议后续做按路由拆包/手动分包。

### 6.2 admin build

```bash
$ cd admin
$ /usr/bin/time -p npm run build:check
...（省略）...
✓ built in 3.54s
real 6.00
```

说明：chunk size > 500k 警告同上；Tailwind warning 已通过 `admin/postcss.config.js` 收口。

### 6.3 server build

```bash
$ cd server
$ /usr/bin/time -p npm run build
> nest build
real 2.35
```

### 6.4 lint

```bash
$ npm run lint
# PASS

$ cd admin && npm run lint
# PASS
```

说明：`server/` 未配置 lint script，本次验收以 `nest build` 作为编译门槛。

## 7) 已修复问题清单（按优先级）

### P0

- 解决方案缺少封面字段：补齐 `solutions.cover_image`，并贯通 admin 上传/保存与 web 展示。
- 线索列表字段缺失：修复 `/api/admin/leads` 返回字段不全的问题（select 别名/字段映射）。
- 线索 owner 外键重复列：修复 `leads.owner_id` / `leads.ownerId` 双列问题，统一使用 `owner_id` 外键。
- 前台调用缺失接口导致 404：补齐 `GET /api/faqs` 与 `GET /api/products/:id/recommendations`。

### P1

- Dashboard 指标卡“点击跳转”体验：整卡可点，且带 `range` 参数跳转到线索列表。
- About/Contact 图片缺失体验：统一 `ImageWithFallback`，避免空白。

### P2

- Vite 构建 chunk size 警告：已记录，建议后续按路由拆包优化。
- npm audit 漏洞：已记录，建议后续评估升级与修复策略。

## 8) 仍存在问题清单（含复现与建议）

1) `npm audit` 存在漏洞（根目录/后台/后端均有）
- 复现：分别在根目录、`admin/`、`server/` 执行 `npm audit`
- 建议：评估升级影响后分批修复；生产环境建议锁定 Node LTS 与依赖版本

2) 构建产物体积偏大（chunk > 500k 警告）
- 复现：`npm run build` / `admin npm run build:check`
- 建议：按路由拆包、对 antd/icon 做按需加载、配置 `manualChunks`

3) `company-info` 当前为空对象
- 现状：`GET /api/company-info` 返回 `{}`，前台已做默认值兜底
- 建议：在后台“公司信息”模块完善公司名称/电话/二维码/SEO 等，增强上线内容完整性

4) Node 版本为 v25（非 LTS）
- 复现：`node -v`
- 建议：生产建议切换 Node 20/22 LTS，并在 CI 中固定版本与构建校验

## 9) 关键 diff 摘要

> 以最终 `git diff --stat` 为准（本次未提交 commit）。

### 9.1 `git diff --stat`（已跟踪文件）

```bash
admin/src/pages/Dashboard/index.tsx                | 16 ++++--
admin/src/pages/Leads/LeadsList.tsx                | 35 +++++++++++-
admin/src/pages/Solutions/index.tsx                | 62 +++++++++++++++++++++-
server/src/app.module.ts                           |  2 +
server/src/modules/content/entities/solution.entity.ts    |  7 +++
server/src/modules/lead/entities/lead.entity.ts    | 10 +---
server/src/modules/lead/lead.service.ts            | 24 ++++-----
server/src/modules/product/product.controller.ts   |  8 +++
server/src/modules/product/product.service.ts      | 33 ++++++++++++
src/pages/About/index.tsx                          | 10 ++--
src/pages/Contact/index.tsx                        |  3 +-
src/pages/Solutions/index.tsx                      | 14 ++++-
src/types/content.ts                               |  1 +
13 files changed, 193 insertions(+), 32 deletions(-)
```

### 9.2 `git status --porcelain`（包含新增文件）

```bash
 M admin/src/pages/Dashboard/index.tsx
 M admin/src/pages/Leads/LeadsList.tsx
 M admin/src/pages/Solutions/index.tsx
 M server/src/app.module.ts
 M server/src/modules/content/entities/solution.entity.ts
 M server/src/modules/lead/entities/lead.entity.ts
 M server/src/modules/lead/lead.service.ts
 M server/src/modules/product/product.controller.ts
 M server/src/modules/product/product.service.ts
 M src/pages/About/index.tsx
 M src/pages/Contact/index.tsx
 M src/pages/Solutions/index.tsx
 M src/types/content.ts
?? admin/postcss.config.js
?? docs/回归清单.md
?? docs/接口对照表.md
?? docs/验收报告.md
?? server/src/modules/faq/
```
